---
layout: page
title:  "ä¸€ä¸ªè¯¡å¼‚çš„ 404 è¯·æ±‚"
date:   2018-06-06 16:30:00 +0800
category: tech nginx
permalink: stracenginx.html
---

### å‘ç°é—®é¢˜
ç”±äºå…¶ä»–é¡¹ç›®ç»„ä½¿ç”¨äº†æˆ‘ä»¬çš„è§†é¢‘æœåŠ¡ï¼ŒæœŸé—´å‡ºç°é—®é¢˜ç»å¸¸æ¥æ‰¾æˆ‘ï¼ˆï½ï¼‰ã€‚æœ€è¿‘å‘Šè¯‰æˆ‘è¯´æœ‰ä¸ªæ–‡ä»¶è®¿é—®æ—¶ä¸æ—¶æŠ¥ 404ï¼Œä»–ä»¬å„ç§è¿½è¸ªæŸ¥ä¸åˆ°é—®é¢˜ã€‚

### é—®é¢˜é‡ç° && å®šä½é—®é¢˜
* é—®é¢˜é‡ç°  
é‡ç°è¿™ä¸ªé—®é¢˜è¿˜æ¯”è¾ƒç®€å•ï¼Œç›´æ¥ `curl` å‘½ä»¤è¯·æ±‚é‚£ä¸ª urlï¼Œç¡®å®æœ‰æ—¶ 200 ï¼Œæœ‰æ—¶ 404 
* å®šä½é—®é¢˜  
ä» `curl â€”I` è¿”å›çš„headerä¸­çœ‹ä¸åˆ°ä»€ä¹ˆæœ‰ç”¨çš„ä¿¡æ¯ã€‚ç”±äºé—®é¢˜çš„å¶å‘æ€§ï¼Œå¼€å§‹æˆ‘ä»¥ä¸ºæ˜¯ nginx çš„è´Ÿè½½å‡è¡¡æœºå™¨ä¸­æŸå°æœºå™¨è®¿é—®æœ‰é—®é¢˜ã€‚ä½†æ˜¯çœ‹äº†ä¸‹çº¿ä¸Šåªæœ‰ä¸¤å°æœºå™¨ï¼Œåˆ†åˆ«ç”¨ `curl -x` ç»‘å®šæµ‹è¯•ä¹Ÿéƒ½å‡ºç°äº† 404
ç„¶åå»çº¿ä¸Šçœ‹ nginx é”™è¯¯æ—¥å¿—ï¼ŒæŠŠæ—¥å¿—çº§åˆ«æ”¹æˆ debugï¼Œè§‚å¯Ÿåˆ° nginx è¿”å› 200 å’Œ 404 çš„è¯·æ±‚å¦‚ä¸‹ï¼š  
```bash
2018/06/05 16:37:33 [notice] 14434#0: *134482 "/(.*)$" matches "/5b05286d83ba88cd5c875907/H.mp4" while sending to client, client: 10.100.136.218, server: video.xxxx.com, request: "GET /5b05286d83ba88cd5c875907/H.mp4 HTTP/1.0", host: "video.xxxx.com", referrer: "http://www.xxxx.com/topic/micro?sid=iw3di1"
2018/06/05 16:37:33 [notice] 14434#0: *134482 rewritten data: "/K12/M00/04/E2/CmSEcVsFL-GAaOm1Agcnmw2-Qfs186.mp4", args: "" while sending to client, client: 10.100.136.218, server: video.xxxx.com, request: "GET /5b05286d83ba88cd5c875907/H.mp4 HTTP/1.0", host: "video.xxxx.com", referrer: "http://www.xxxx.com/topic/micro?sid=iw3di1"
2018/06/05 16:39:47 [info] 14432#0: *134485 client 10.98.16.109 closed keepalive connection
```
```bash
2018/06/05 16:37:26 [info] 14434#0: *134481 client 10.98.16.109 closed keepalive connection
```

å¯ä»¥çœ‹åˆ°ä¸‹é¢çš„ 404 è¯·æ±‚åªæœ‰ä¸€æ¡ `closed keepalive connection`ï¼Œéš¾é“è¯·æ±‚è¿˜æ²¡æœ‰è¢« nginx æ¥æ”¶å¤„ç†ï¼Ÿ  
æˆ–è€…è¯´ï¼Œ nginx å¤„ç†è¯·æ±‚çš„æ—¶å€™å‘ç”Ÿäº†é”™è¯¯ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰è®°å½•æ—¥å¿—ï¼  
äº‹å®è¯æ˜ï¼Œç¡®å®æ˜¯åè€…ã€‚
### é—®é¢˜æ ¹æº
ç”±äº nginx æ—¥å¿—èƒ½çœ‹åˆ°çš„å†…å®¹æœ‰é™ï¼Œè¦çŸ¥é“ nginx æœ‰æ²¡æœ‰å¤„ç†è¯·æ±‚ï¼Œåªèƒ½å¦æƒ³å…¶ä»–åŠæ³•äº†ã€‚è¶…å“¥æŒ‡å¯¼ä¸‹ï¼Œç”¨ `strace` è·Ÿè¸ªä¸€ä¸‹ nginx çš„ worker è¿›ç¨‹ã€‚æœç„¶å‘ç°äº†é—®é¢˜  
ä¸‹é¢æ˜¯ç”¨ `strace` è·Ÿè¸ªçš„ 200 å’Œ 404 è¯·æ±‚  
 è¯·æ±‚ 200
![200](/assets/post-images/strace/200.png)
 è¯·æ±‚ 404
![404](/assets/post-images/strace/404.png)
ä¸Šé¢çš„å›¾ï¼Œå°±å¯ä»¥çœ‹å‡ºæ¥é—®é¢˜æ‰€åœ¨äº†ï¼Œ nginx å†…éƒ¨è¯·æ±‚ redis çš„æ—¶å€™æœ‰æ—¶è¿”å›æˆåŠŸï¼Œæœ‰æ—¶è¿”å›ç©ºï¼  
å» redis éªŒè¯ä¸€ä¸‹ï¼Œæœç„¶  
![404](/assets/post-images/strace/redis.png)
### ç”©é”…æŒ‡å—ï¼ˆğŸ˜„ï¼‰
æ‰€ä»¥ä¸€å¼€å§‹çš„åˆ¤æ–­è¿˜æ˜¯æ²¡é”™çš„ï¼Œç¡®å®æ˜¯è´Ÿè½½å‡è¡¡æŸå°æœºå™¨å‡ºç°äº†é—®é¢˜  
è™½ç„¶ä¸æ˜¯ nginx æ˜¯ redis 
ç„¶åè€å¤§æˆåŠŸæŠŠè¿™ä¸ª redis çš„é”…é¢†èµ°ï½