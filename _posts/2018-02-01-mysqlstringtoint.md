---
layout: page
title:  "MySQL 隐式类型转换的一些实验"
date:   2018-02-01 10:12:01 +0800
category: tech mysql database
permalink: mysqlimplicitetypeconversion.html
---

```
说明: 这个实验针对使用 单引号 查询 int / bigint 类型的数据
其他类型转换不在实验范围内！
```

### 测试表
```
CREATE TABLE `sql_test` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `uid` int(11) NOT NULL DEFAULT '0',
  `seq` int(11) NOT NULL DEFAULT '0',
  `desc` varchar(60) DEFAULT NULL,
  `bigid` bigint(20) NOT NULL DEFAULT '0',
  PRIMARY KEY (`id`),
  KEY `seq` (`seq`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1
```

字段 | 类型 | 索引 | 
-- | -- | -- |
id | int | primary
uid | int | -- | 
seq | int | key | 
desc | varchar | -- | 
bigid | bigint | -- |

> 初始数据

```sql
mysql> select * from sql_test;
+----+-----+------------+-------------+---------------------+
| id | uid | seq        | desc        | bigid               |
+----+-----+------------+-------------+---------------------+
|  1 | 125 |        456 | 2354326547  |         23873947593 |
|  2 | 123 |         67 | 24326547    |         24623947593 |
|  3 | 233 |         78 | 243234547   |         24623942593 |
|  4 |  27 |         87 | 24323344547 |        246239345593 |
|  5 |  42 |        234 | 235251      | 9223372036854775807 |
|  6 |  42 |        234 | 235251      | 9223372036854775807 |
|  7 |  42 |        234 | 235251      | 9223372036854775807 |
|  8 |  48 |        358 | 3r3r8327    | 9223372036854775807 |
|  9 |  48 | 2147483647 | 3r3r8327    | 9223372036854775807 |
+----+-----+------------+-------------+---------------------+
9 rows in set (0.00 sec)
```

#### 测试 1 (无索引字段查询)
```
mysql> explain select * from sql_test where uid = 125;
+----+-------------+----------+------+---------------+------+---------+------+------+-------------+
| id | select_type | table    | type | possible_keys | key  | key_len | ref  | rows | Extra       |
+----+-------------+----------+------+---------------+------+---------+------+------+-------------+
|  1 | SIMPLE      | sql_test | ALL  | NULL          | NULL | NULL    | NULL |    4 | Using where |
+----+-------------+----------+------+---------------+------+---------+------+------+-------------+
1 row in set (0.00 sec)

mysql> explain select * from sql_test where uid = '125';
+----+-------------+----------+------+---------------+------+---------+------+------+-------------+
| id | select_type | table    | type | possible_keys | key  | key_len | ref  | rows | Extra       |
+----+-------------+----------+------+---------------+------+---------+------+------+-------------+
|  1 | SIMPLE      | sql_test | ALL  | NULL          | NULL | NULL    | NULL |    4 | Using where |
+----+-------------+----------+------+---------------+------+---------+------+------+-------------+
1 row in set (0.00 sec)
```

#### 测试 2 (索引字段查询)
```
mysql> explain select * from sql_test where seq = 456;
+----+-------------+----------+------+---------------+------+---------+-------+------+-------+
| id | select_type | table    | type | possible_keys | key  | key_len | ref   | rows | Extra |
+----+-------------+----------+------+---------------+------+---------+-------+------+-------+
|  1 | SIMPLE      | sql_test | ref  | seq           | seq  | 4       | const |    1 |       |
+----+-------------+----------+------+---------------+------+---------+-------+------+-------+
1 row in set (0.00 sec)

mysql> explain select * from sql_test where seq = '456';
+----+-------------+----------+------+---------------+------+---------+-------+------+-------+
| id | select_type | table    | type | possible_keys | key  | key_len | ref   | rows | Extra |
+----+-------------+----------+------+---------------+------+---------+-------+------+-------+
|  1 | SIMPLE      | sql_test | ref  | seq           | seq  | 4       | const |    1 |       |
+----+-------------+----------+------+---------------+------+---------+-------+------+-------+
1 row in set (0.00 sec)
```

#### 测试 3 (int 最大值测试)
```sql
mysql> select * from sql_test where seq = '2147483647';
+----+-----+------------+----------+---------------------+
| id | uid | seq        | desc     | bigid               |
+----+-----+------------+----------+---------------------+
|  9 |  48 | 2147483647 | 3r3r8327 | 9223372036854775807 |
+----+-----+------------+----------+---------------------+
1 row in set (0.00 sec)

mysql> select * from sql_test where seq = '2147483648';
Empty set, 1 warning (0.00 sec)

mysql> show warnings;
+---------+------+----------------------------------------------+
| Level   | Code | Message                                      |
+---------+------+----------------------------------------------+
| Warning | 1264 | Out of range value for column 'seq' at row 1 |
+---------+------+----------------------------------------------+
1 row in set (0.00 sec)
```

#### 测试 3 (bigint 最大值测试) [出错！]
```sql
mysql> select * from sql_test where bigid = '9223372036854775809';
+----+-----+-----+----------+---------------------+
| id | uid | seq | desc     | bigid               |
+----+-----+-----+----------+---------------------+
|  5 |  42 | 234 | 235251   | 9223372036854775807 |
|  6 |  42 | 234 | 235251   | 9223372036854775807 |
|  7 |  42 | 234 | 235251   | 9223372036854775807 |
|  8 |  48 | 358 | 3r3r8327 | 9223372036854775807 |
+----+-----+-----+----------+---------------------+
4 rows in set (0.00 sec)

mysql> select * from sql_test where bigid = 9223372036854775809;
Empty set (0.00 sec)

-- 这里可以说是mysql一个经典错误了
```

#### 测试 4 (转换特殊情况测试)
```sql
mysql> select * from sql_test where seq = '456abc';
+----+-----+-----+------------+-------------+
| id | uid | seq | desc       | bigid       |
+----+-----+-----+------------+-------------+
|  1 | 125 | 456 | 2354326547 | 23873947593 |
+----+-----+-----+------------+-------------+
1 row in set, 2 warnings (0.00 sec)

mysql> show warnings;
+---------+------+--------------------------------------------+
| Level   | Code | Message                                    |
+---------+------+--------------------------------------------+
| Warning | 1265 | Data truncated for column 'seq' at row 1   |
| Warning | 1292 | Truncated incorrect DOUBLE value: '456abc' |
+---------+------+--------------------------------------------+
2 rows in set (0.01 sec)
```

#### 测试 5 (空字符串测试)
```sql
mysql> explain select * from sql_test where seq = '';
+----+-------------+----------+------+---------------+------+---------+-------+------+-------------+
| id | select_type | table    | type | possible_keys | key  | key_len | ref   | rows | Extra       |
+----+-------------+----------+------+---------------+------+---------+-------+------+-------------+
|  1 | SIMPLE      | sql_test | ref  | seq           | seq  | 4       | const |    1 | Using where |
+----+-------------+----------+------+---------------+------+---------+-------+------+-------------+
1 row in set, 1 warning (0.00 sec)

mysql> select * from sql_test where seq = '';
Empty set, 1 warning (0.00 sec)

mysql> show warnings;
+---------+------+-------------------------------------------------------+
| Level   | Code | Message                                               |
+---------+------+-------------------------------------------------------+
| Warning | 1366 | Incorrect integer value: '' for column 'seq' at row 1 |
+---------+------+-------------------------------------------------------+
1 row in set (0.00 sec)
```


#### 测试结果
1. int型数据使用 '' 查询对查询结果无影响
2. bigint使用 '' 查询会对结果造成影响
3. 空字符串查询无影响(warning)
4. 使用 '' 查询对索引效果无影响